<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009"
		xmlns:s="library://ns.adobe.com/flex/spark" 
		xmlns:mx="library://ns.adobe.com/flex/mx"
		xmlns:components="components.*" 
		title="Scout" 
		backgroundColor="#f2f3f4" 
		contentBackgroundColor="#f2f3f4">
	<fx:Script source="../func/globalFunctions.as"/>
	<fx:Script>
		<![CDATA[
			import flash.events.MouseEvent;
			import mx.collections.ArrayCollection;
			import mx.rpc.events.ResultEvent;
			import spark.events.ViewNavigatorEvent;
			import spark.managers.PersistenceManager;
			import spark.events.ViewNavigatorEvent;
			[Bindable]
			public var busy:Boolean = false;
			public function authorizeLogin(username:String,userpassword:String):void{	
				busy = true;
				userid = username;
				passid = userpassword;
				checkLogin.send();
			}
			public function afterCheckLogin(ev:ResultEvent):void {
				busy = false;
				if (ev.result[0].ress.message == "ok"){
					AddNewLocalUser(ev.result[0].ress.email,
						ev.result[0].ress.name,
						ev.result[0].ress.country);
				}
				else {
					//bad login
					logWarningTextinfo.text = ev.result[0].ress.message;
					popupholder1.visible = true;
				}
			}
			public function AddNewLocalUser(email:String,name:String,country:String):void
			{
				busy = true;
				sqlConnection = new SQLConnection();
				sqlConnection.open(File.applicationStorageDirectory.resolvePath("localuser.db"));
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "delete FROM localuser;";
				stmt.execute();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "INSERT into localuser values(:email,:name,:country,:active)";
				stmt.parameters[":email"] = email;
				stmt.parameters[":name"] = name;
				stmt.parameters[":country"] = country;
				stmt.parameters[":active"] = "yes";
				stmt.execute();
				getLocalUsers();
			}
			protected function getLocalUsers():void
			{
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "SELECT email, name, country, active FROM localuser";
				stmt.execute();
				var resData:ArrayCollection = new ArrayCollection(stmt.getResult().data);
				if (resData.length != 0){
					//good login
					var foundactive:Boolean = false;
					for (var i:uint = 0; i < resData.length; i++){
						if (resData[i].active == "yes"){
							foundactive = true;
							popupholder1.visible = false;
							var saveManager:PersistenceManager = new PersistenceManager();
							saveManager.setProperty("useremail", resData[i].email);
							this.parentDocument.refresh(resData[i].email);	
						}
					}			
				}
				else {}
				busy = false;
			}
			protected function userPasswordInput_keyDownHandler(event:KeyboardEvent):void
			{
				if (event.keyCode == 13){
					authorizeLogin(userNameInput.text,userPasswordInput.text);	
				}
			}
			
			public function signupclick(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				navigator.pushView(Signup_step1);
			}
			
			public function fofacebook(event:MouseEvent):void
			{
				// TODO Auto-generated method stub
				navigator.pushView(FacebookTest);
			}
			
		]]>
	</fx:Script>
	<fx:Declarations>	
		<fx:String id="userid" />
		<fx:String id="passid" />
		<s:HTTPService id="checkLogin" method="POST" 
					   resultFormat="array" 
					   url="http://www.scoutcard.ca/php/mobile_v2/checkLogin.php"
					   result="afterCheckLogin(event)" >
			<s:request xmlns="">
				<userid>{userid}</userid>		
				<passid>{passid}</passid>
				<versionnumber>2</versionnumber>	
			</s:request>
		</s:HTTPService>
	</fx:Declarations>
	<s:Scroller left="0" right="0" top="0" bottom="0" verticalScrollPolicy="on" horizontalScrollPolicy="off" >
			<s:VGroup gap="{20/(320/Capabilities.screenDPI)}" width="100%" 
					  horizontalCenter="0" verticalCenter="0"  
					  paddingTop="{20/(320/Capabilities.screenDPI)}"
					  bottom="0" horizontalAlign="center" verticalAlign="top">
				<s:Label text="Sign In to your Account" color="#737171"  styleName="textsize5"/>
				<components:facebook click="fofacebook(event)"/>
				<components:or/>
				<components:twitter/>
				<components:or/>
				<s:VGroup horizontalAlign="center" width="100%" 
						  gap="{10/(320/Capabilities.screenDPI)}">
					<s:Group width="100%" >
						<s:Rect id="textback1" width="{550/(320/Capabilities.screenDPI)}" 
								height="{100/(320/Capabilities.screenDPI)}" 
								horizontalCenter="0" verticalCenter="0"
								radiusX="{10/(320/Capabilities.screenDPI)}" 
								radiusY="{10/(320/Capabilities.screenDPI)}" >
							<s:fill>
								<s:SolidColor alpha="1" color="#FFFFFF"/>
							</s:fill>
						</s:Rect>
						<s:TextInput id="userNameInput"  
									 width="{textback1.width}"
									 height="{textback1.height}"
									 verticalCenter="0"
									 horizontalCenter="0"
									 borderVisible="false"
									 contentBackgroundAlpha="0"
									 prompt="Email"/>
					</s:Group>
					<s:Group width="100%">
						<s:Rect id="textback2" width="{550/(320/Capabilities.screenDPI)}" 
								height="{100/(320/Capabilities.screenDPI)}" 
								horizontalCenter="0" verticalCenter="0"
								radiusX="{10/(320/Capabilities.screenDPI)}"
								radiusY="{10/(320/Capabilities.screenDPI)}" >
							<s:fill>
								<s:SolidColor alpha="1" color="#FFFFFF"/>
							</s:fill>
						</s:Rect>
						<s:TextInput id="userPasswordInput"  
									 width="{textback2.width}"
									 height="{textback2.height}"
									 verticalCenter="0"
									 horizontalCenter="0"
									 displayAsPassword="true"
									 contentBackgroundAlpha="0"
									 prompt="Password"
									 borderVisible="false"
									 keyDown="userPasswordInput_keyDownHandler(event)"/>
					</s:Group>
					<components:continue_btn click="authorizeLogin(userNameInput.text,userPasswordInput.text)" />
					<s:Group width="{textback2.width}" >
						<s:Label paddingTop="{10/(320/Capabilities.screenDPI)}" verticalCenter="0" text="Forgot password?" styleName="textsize3"  color="#5cb2ed"/>
					</s:Group>
				</s:VGroup>
				

				<s:Group verticalCenter="0" width="{textback2.width}" >
					<s:Label left="0" text="Need an Account?" verticalCenter="0" color="#737171"
							 styleName="textsize5"/>
					<components:signup right="0" verticalCenter="0" click="signupclick(event)"  />
				</s:Group>
		</s:VGroup>
	</s:Scroller>
	<s:BusyIndicator visible="{busy}" verticalCenter="0" horizontalCenter="0"/>
	<s:Group id="popupholder1"  width="100%" height="100%" visible="false">
		<s:Rect width="100%" height="100%">
			<s:fill><s:SolidColor alpha="0.5" color="#000000"/></s:fill>
		</s:Rect>
		<s:Group id="popupholder2" width="85%"  height="85%"
				 horizontalCenter="0" verticalCenter="0"
				 mouseDownOutside="{popupholder1.visible = false}">
			<s:Rect width="100%" height="100%">
				<s:fill><s:SolidColor alpha="1" color="#FFFFFF"/></s:fill>
			</s:Rect>
			
			<!-- PUT POPUP CONTENTS HERE  -->
			<s:Label id="logWarningTextinfo" textAlign="center"
					 color="#656565"   width="90%"
					 horizontalCenter="0"
					 verticalCenter="0" 
					 styleName="textsize13"
					 verticalAlign="middle" 
					 text="Sorry Incorrect Information"/>
			<!-- END OF PUT POPUP CONTENTS HERE  -->
			
			<s:Group height="15%" width="100%" bottom="0" 
					 click="{popupholder1.visible = false}"
					 mouseDown="gDown(event);" mouseOver="gOver(event);"
					 mouseOut="gOut(event);" mouseUp="gOut(event);">
				<s:Rect width="100%" height="100%">
					<s:fill><s:SolidColor alpha="1" color="#0aaae5"/></s:fill>
				</s:Rect>
				<s:Label text="Close" color="#FFFFFF" styleName="textsize6"
						 mouseEnabled="false" horizontalCenter="0" verticalCenter="0"/>
			</s:Group>
		</s:Group>
	</s:Group>
</s:View>