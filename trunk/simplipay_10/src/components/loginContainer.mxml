<?xml version="1.0" encoding="utf-8"?>
<s:BorderContainer width="100%" height="100%" 
				   xmlns:mx="library://ns.adobe.com/flex/mx"
				   xmlns:s="library://ns.adobe.com/flex/spark" 
				   xmlns:fx="http://ns.adobe.com/mxml/2009" >
	<fx:Script>
		<![CDATA[
			import spark.effects.Fade;
			import spark.transitions.FlipViewTransition;
			import spark.transitions.FlipViewTransitionMode;
			import spark.transitions.ViewTransitionDirection;
			import flash.data.SQLConnection;
			import flash.data.SQLStatement;
			import flash.display.Bitmap;
			import flash.display.Sprite;
			import flash.events.MouseEvent;
			import flash.filesystem.File;
			import mx.collections.ArrayCollection;
			import mx.core.UIComponent;
			import mx.events.FlexEvent;
			import mx.rpc.events.ResultEvent;			
			import org.qrcode.QRCode;			
			import spark.events.ViewNavigatorEvent;			
			import views.LoyaltyHome;
			import views.MyAccountHome;
			import flash.data.SQLConnection;
			import flash.data.SQLStatement;
			import flash.events.Event;
			import flash.events.MouseEvent;
			import flash.filesystem.File;
			import model.Smurf;
			import mx.collections.ArrayCollection;
			import mx.effects.Move;
			import mx.events.EffectEvent;
			import mx.events.FlexEvent;
			import mx.rpc.events.ResultEvent;
			import spark.effects.Scale;
			import spark.events.ViewNavigatorEvent;
			import flash.events.Event;
			import flash.events.MouseEvent;
			import mx.events.DragEvent;
			import spark.filters.GlowFilter;

			[Bindable]
			public var currentBalance:String = "$0.00";	
			[Bindable]
			public var loginType:Number = -1;
			public var profileShown:Boolean = false;
			public var chosenMenuOption:uint = 1;
			public var profWaiting:Boolean = false;
			protected var sqlConnection:SQLConnection;
			public var profDraging:Boolean = false;
			
			public function create():void
			{
				sqlConnection = new SQLConnection();
				sqlConnection.open(File.applicationStorageDirectory.resolvePath("localuser.db"));
				var stmt:SQLStatement = new SQLStatement();
				//stmt.sqlConnection = sqlConnection;
				////stmt.text = "Drop TABLE localuser";
				//stmt.execute();			
				stmt.sqlConnection = sqlConnection;
				stmt.text = "CREATE TABLE IF NOT EXISTS localuser (" +
					"email varchar(255)," +
					"name varchar(255)," +
					"country varchar(255))";
				stmt.execute();
				getLocalUsers();
			}	
			public function loginClick(event:MouseEvent):void
			{	
				v12.visible = false;
				v11.visible = false;
				v2.visible = true;
				v3.visible = false;
				newlogWarning.visible = false;
				logWarning.visible = false;
			}
			public function createNewClick(event:MouseEvent):void {
				v12.visible = false;
				v11.visible = false;
				v2.visible = false;
				v3.visible = true;
				newlogWarning.visible = false;
				logWarning.visible = false;
			}
			public function backToLoginOptions():void {
				if (loginType == 0){
					v11.visible = true;
				}
				else {
					v12.visible = true;
				}
				v2.visible = false;
				v3.visible = false;
				newlogWarning.visible = false;
				logWarning.visible = false;
			}
			public function authorizeLogin(username:String,userpassword:String):void{	
				userid = username;
				passid = userpassword;
				checkLogin.send();
			}
			public function afterCheckLogin(ev:ResultEvent):void {
				if (ev.result[0].res.message == "ok"){
					AddNewLocalUser(ev.result[0].res.email,
						ev.result[0].res.name,
						ev.result[0].res.country);
				}
				else {
					//bad login
					logWarning.visible = true;
				}
			}
			protected function getLocalUsers():void
			{
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "SELECT email, name, country FROM localuser";
				stmt.execute();
				var resData:ArrayCollection = new ArrayCollection(stmt.getResult().data);
				
				if (resData.length != 0){
					//good login
					var samp:String = resData[0].birthday;
					var stop2:String = "";
					v11.visible = false;
					v12.visible = false;
					v2.visible = false;
					v3.visible = false;
					logWarning.visible = false;
					newlogWarning.visible = false;
					if (loginType == 0){
						
						this.parentDocument.navigator.pushView(MyAccountHome, {name:resData[0].name,
							email:resData[0].email});
					}
					else {
						this.parentDocument.navigator.pushView(LoyaltyHome, {name:resData[0].name,
							email:resData[0].email});
					}	
				}
				else {
					//bad login or no local saved login.
					var stop:String = "";	
				}
			}
			public function logout():void {
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "delete from localuser";
				stmt.execute();
				//navigator.popToFirstView();
				if (loginType == 0){
					v11.visible = true;
				}
				else {
					v12.visible = true;
				}
				v2.visible = false;
				v3.visible = false;
				//logoutBTN.visible  = false;
				logWarning.visible = false;
				
			}
			public function AddNewLocalUser(email:String,name:String,country:String):void
			{
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "INSERT into localuser values(:email,:name,:country)";
				stmt.parameters[":email"] = email;
				stmt.parameters[":name"] = name;
				stmt.parameters[":country"] = country;
				stmt.execute();
				getLocalUsers();
			}
			public function checkAvailability(username:String,userpassword:String):void {	
				if ((newEmail.text != "")&&(newEmail.text.indexOf("@") != -1)&&(newPassword.text != "")&&
					(newName.text != "")&&(newCountry.selectedIndex != -1)){
					newlogWarning.visible = false;
					newEmail2 = newEmail.text;
					newPassword2 = newPassword.text;
					newName2 = newName.text;
					newCountry2 = newCountry.selectedItem;
					createNewUser.send();
				}
				else {
					newlogWarning.visible = true;
				}	
			}
			public function afterCreateNewUser(ev:ResultEvent):void {
				if (ev.result[0].res.message == "ok"){
					AddNewLocalUser(ev.result[0].res.email,
						ev.result[0].res.name,
						ev.result[0].res.country
					);
				}
				else {
					//bad login
					newlogWarning.visible = true;
					newlogWarning.text = ev.result[0].res.message;
				}
			}
			public function tOver(ev:MouseEvent):void {
				ev.currentTarget.setStyle("textDecoration","underline");
			}
			public function tOut(ev:MouseEvent):void {
				ev.currentTarget.setStyle("textDecoration","none");
			}
			public function gOver(ev:MouseEvent):void {
				var gl:GlowFilter = new GlowFilter(000000,1,4,4,1,1,true);
				ev.currentTarget.filters = [gl];
			}
			public function gDown(ev:MouseEvent):void {
				var gl:GlowFilter = new GlowFilter(000000,1,4,4,1,1,true);
				ev.currentTarget.filters = [gl];
			}
			public function gOut(ev:MouseEvent):void {
				ev.currentTarget.filters = [];
			}
			public function profDown(ev:MouseEvent):void {
				var gl:GlowFilter = new GlowFilter(000000,1,4,4,1,1,true);
				ev.currentTarget.filters = [gl];		
			}
			public function profUp(ev:MouseEvent):void {
				ev.currentTarget.filters = [];
			}
		]]>
	</fx:Script>
	<fx:Declarations>	
		<s:RadioButtonGroup id="newGendergroup"/>
		<fx:String id="userid" />
		<fx:String id="passid" />
		<fx:String id="newEmail2" />
		<fx:String id="newPassword2" />
		<fx:String id="newName2" />
		<fx:String id="newGender2" />
		<fx:String id="newBirthday2" />
		<fx:String id="newBirthmonth2" />
		<fx:String id="newBirthyear2" />
		<fx:String id="newCountry2" />
		<s:HTTPService id="checkLogin" method="POST" 
					   resultFormat="array" 
					   url="http://simplipay.ca/php/checkLoginMobile.php"
					   result="afterCheckLogin(event)" >
			<s:request xmlns="">
				<userid>{userid}</userid>		
				<passid>{passid}</passid>		
			</s:request>
		</s:HTTPService>
		<s:HTTPService id="createNewUser" method="POST" 
					   resultFormat="array" 
					   url="http://simplipay.ca/php/createNewUserMobile.php"
					   result="afterCreateNewUser(event)" >
			<s:request xmlns="">
				<newEmail2>{newEmail2}</newEmail2>		
				<newPassword2>{newPassword2}</newPassword2>	
				<newName2>{newName2}</newName2>		
				<newCountry2>{newCountry2}</newCountry2>	
			</s:request>
		</s:HTTPService>
	</fx:Declarations>
	<s:Scroller left="0"  id="v11" visible="{loginType == 0}" right="0" top="0" bottom="0" verticalScrollPolicy="on" horizontalScrollPolicy="off" >
		<s:VGroup width="100%" height="100%" >
			<s:BorderContainer  width="100%" height="100%" backgroundAlpha="0" borderAlpha="0" >
				
				
				<s:Label top="81" fontWeight="normal" horizontalCenter="0" text="The Fastest Way to Pay"/>
				<s:Label top="106" width="268" color="#6F6F6F" fontSize="14" fontWeight="normal"
						 horizontalCenter="0"
						 text="Use your phone to pay for items, check your balance, and reload your account with credit."/>
				<s:Image top="12" width="169" height="73" horizontalCenter="0" source="assets/howtopay.png"/>
				<s:Image top="168" width="299" height="64" click="createNewClick(event)" horizontalCenter="0" source="assets/signup.png"/>
				<s:Image top="232" width="299" height="64" click="loginClick(event)" horizontalCenter="0" source="assets/signin.png"/>
				
			</s:BorderContainer>
		</s:VGroup>
		</s:Scroller>
	<s:Scroller left="0" id="v12" visible="{loginType == 1}" right="0" top="0" bottom="0" verticalScrollPolicy="on" horizontalScrollPolicy="off" >
		<s:VGroup width="100%" height="100%" >
	<s:BorderContainer  width="100%" height="100%" backgroundAlpha="0" borderAlpha="0" >
		<s:Label top="81" fontWeight="normal" horizontalCenter="0" text="Make Your Money Count"/>
		<s:Label top="311" color="#1357AC" mouseOut="tOut(event)" mouseOver="tOver(event)" fontWeight="normal" horizontalCenter="0"
				 text="Learn about our Loyalty Program"/>
		<s:Label top="106" width="268" color="#6F6F6F" fontSize="14" fontWeight="normal"
				 horizontalCenter="0"
				 text="With the Simplipay loyalty program your earn points every time you spend. Each point equals $1, so you can earn while you spend."/>
		<s:Image top="7" width="169" height="66" horizontalCenter="0" source="assets/loyalty-1.png"/>
		<s:Image top="168" width="299" height="64" click="createNewClick(event)" horizontalCenter="0" source="assets/signup.png"/>
		<s:Image top="232" width="299" height="64"  click="loginClick(event)" horizontalCenter="0" source="assets/signin.png"/>
	</s:BorderContainer>
		</s:VGroup>
	</s:Scroller>
	<s:Scroller left="0" id="v2" visible="false" right="0" top="0" bottom="0" verticalScrollPolicy="on" horizontalScrollPolicy="off" >
		<s:VGroup width="100%" height="100%" >
	<s:BorderContainer  width="100%" height="100%" backgroundAlpha="0" borderAlpha="0" >
		<s:TextInput id="userNameInput" top="11" width="254" horizontalCenter="0" prompt="Username"/>
		<s:TextInput id="userPasswordInput" top="43" width="254" displayAsPassword="true"
					 horizontalCenter="0" prompt="Password"/>
		<s:Button top="79" width="103" height="37" label="Sign In"
				  click="authorizeLogin(userNameInput.text,userPasswordInput.text)"
				  fontFamily="_sans" fontWeight="normal" horizontalCenter="77"/>
		<s:Button top="79" width="103" click="backToLoginOptions();" height="37" label="Cancel" fontFamily="_sans"
				  fontWeight="normal" horizontalCenter="-75"/>
		<s:Label top="123" fontFamily="_sans" visible="false" id="logWarning" fontWeight="bold" horizontalCenter="0"
				 text="Sorry Incorrect Information"/>
	</s:BorderContainer>
		</s:VGroup>
	</s:Scroller>
			<s:Scroller left="0" id="v3" visible="false" right="0" top="0" bottom="0" verticalScrollPolicy="on" horizontalScrollPolicy="off" >
				<s:VGroup width="100%" height="100%" >
	<s:BorderContainer  width="100%" height="100%" backgroundAlpha="0" borderAlpha="0" >
		<s:Label top="12" color="#000000" fontFamily="_sans" fontWeight="normal"
				 horizontalCenter="0" text="Enter Your Information"/>
		<s:TextInput id="newEmail" top="43" width="214" horizontalCenter="0" prompt="Email"/>
		<s:TextInput id="newPassword" y="79" width="214" displayAsPassword="true"
					 horizontalCenter="0" prompt="password"/>
		<s:TextInput id="newName" y="117" width="214" horizontalCenter="0" prompt="Name"/>
		<s:Label y="160" color="#000000" fontFamily="_sans" fontWeight="normal"
				 horizontalCenter="-75" text="Country" textAlign="right"/>
		<s:DropDownList x="123" id="newCountry" selectedIndex="0" y="157" width="140"> 
			<mx:ArrayCollection>
				<fx:String>Canada</fx:String>
				<fx:String>USA</fx:String>
			</mx:ArrayCollection>
		</s:DropDownList>
		<s:Button top="187" width="103" height="37" click="checkAvailability(newEmail.text,newPassword.text);" label="Submit" fontFamily="_sans"
				  fontWeight="normal" horizontalCenter="55"/>
		<s:Button top="187" width="103" height="37" click="backToLoginOptions();"  label="Cancel" fontFamily="_sans"
				  fontWeight="normal" horizontalCenter="-54"/>
		<s:Label top="232" fontFamily="_sans" visible="false" id="newlogWarning" fontWeight="bold" horizontalCenter="0"
				 text="Sorry Incorrect Information"/>
	</s:BorderContainer>
				</s:VGroup>
			</s:Scroller>
</s:BorderContainer>
