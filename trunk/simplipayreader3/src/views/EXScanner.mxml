<?xml version="1.0" encoding="utf-8"?>
<s:View xmlns:fx="http://ns.adobe.com/mxml/2009"
		visible="true" 
		xmlns:s="library://ns.adobe.com/flex/spark" 
		keyUp="keypress(event)"
		title="Simplipay External Scanner" 
		xmlns:components="components.*" >
	
	<fx:Declarations>
		
		<s:HTTPService id="payGo" method="POST" 
					   resultFormat="array" 
					   url="http://simplipay.ca/php/handshake/startprocess.php"
					   result="afterProcess(event)" >
			<s:request xmlns="">
				<code>{code}</code>	
				<amount>{amount}</amount>	
				<gst>{gst}</gst>
				<merchid>{merchid}</merchid>
				<locationid>{locationid}</locationid>
			</s:request>
		</s:HTTPService>
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import flash.data.SQLConnection;
			import flash.data.SQLStatement;
			
			import mx.collections.ArrayCollection;
			import mx.messaging.channels.StreamingAMFChannel;
			import mx.rpc.events.ResultEvent;
			
			import spark.events.ViewNavigatorEvent;
			import spark.filters.GlowFilter;
			[Bindable]
			public var scanningMode:Boolean = false;
			[Bindable]
			public var scannedText:String = "";
			public var scannedText2:String = "";
			[Bindable]
			public var userID:String = "";
			[Bindable]
			public var payamount:Number = 0;
			[Bindable]
			public var code:String = "";
			[Bindable]
			public var logcode:String = "";
			[Bindable]
			public var amount:String = "";
			[Bindable]
			public var gst:String = "5";
			[Bindable]
			public var merchid:uint = 1;
			[Bindable]
			public var locationid:uint = 1;
			protected var sqlConnection:SQLConnection;
			public var codeArray:Array = new Array();
			public function scanPress(event:MouseEvent):void {
				scannedText = "";
				scannedText2 = "";
				scanBTN.enabled = false;
				userLBL.text = "Scanning User...";
				scanningMode = true;
/*				if (scanBTN.text == "Scan User"){
					scannedText = "";
					scannedText2 = "";
					codeArray = new Array();
					scanBTN.text = "Stop Scan";
					userLBL.text = "Scanning User...";
					scanningMode = true;
				}
				else if (scanBTN.text == "Process Payment"){
					if (scannedText2.toLowerCase().indexOf('formalendofstatement') != -1){
						amount = totalValue.text;
						code = scannedText2.substring(0,scannedText2.toLowerCase().indexOf('formalendofstatement')).toLowerCase();
						payGo.send();
					}
					else {
						reset(event);
					}
					
				}
				else if (scannedText2.toLowerCase().indexOf('formalendofstatement') != -1){
					goodScan(scannedText2);	
				}		
				else {
					reset(event);
				}*/
			}
			public function processPress(ev:MouseEvent):void {
				amount = totalValue.text;
				code = scannedText2.substring(0,scannedText2.toLowerCase().indexOf('formalendofstatement')).toLowerCase();
				payGo.send();
			}
			public function resetPress(event:MouseEvent):void {
				scanBTN.enabled = false;
				resetBTN.enabled = true;
				processBTN.enabled = false;
				totalValue.text = "0.00";
				codeArray = new Array();
				payamount = 0;
				scannedText = "";
				scannedText2 = "";
				scanningMode = false;
				userLBL.text = "Please Scan a User";
				/*scanBTN.text = "Scan User";
				userLBL.text = "Scan Aborted";
				scanningMode = false;
				codeArray = new Array();*/
			}
			public function process(s:String):void
			{
				// TODO Auto-generated method stub
				if (totalValue.text == "0.00"){
					totalValue.text = "";
				}
				
				if (s == 'c'){
					totalValue.text = "";
					scanBTN.enabled = true;
					resetBTN.enabled = true;
					processBTN.enabled = false;
					codeArray = new Array();
					payamount = 0;
					scannedText = "";
					scannedText2 = "";
					scanningMode = false;
					userLBL.text = "Please Scan a User";
				}
				else {
					if (scanningMode == false){
						scanBTN.enabled = true;
					}
					
					var ptv:String =  totalValue.text + s;
					if (ptv.indexOf(".") != -1){
						if (ptv.indexOf(".") != ptv.lastIndexOf(".")){
							
						}
						else {
							var temp:String = ptv.substring(ptv.indexOf(".")+1,ptv.length);
							if (temp.length > 2){
								
							}
							else {
								totalValue.text = totalValue.text + s;
							}	
						}
						
					}
					else {
						totalValue.text = totalValue.text + s;
					}
				
				}
			}
			public function keypress(event:KeyboardEvent):void
			{
				if (scanningMode){
					var me:String = String.fromCharCode(event.charCode);
					scannedText = scannedText+me;
					scannedText2 = scannedText2+me;
					codeArray.push(me);
					if (scannedText2.toLowerCase().indexOf('formalendofstatement') != -1){
						goodScan(scannedText2);
					}
				}
			}
			public function goodScan(s:String):void {
				userLBL.text = "Scan Finished, Please Process Payment";
				scanningMode = false;
				processBTN.enabled = true;		
			}
			public function afterProcess(ev:ResultEvent):void {
				var stop:String = "";
				var message:String = ev.result[0].res.message;
				scanBTN.enabled = true;
				resetBTN.enabled = true;
				processBTN.enabled = false;
				totalValue.text = "0.00";
				codeArray = new Array();
				payamount = 0;
				scannedText = "";
				scannedText2 = "";
				scanningMode = false;
				userLBL.text = message;
			}
			public function gOver(ev:MouseEvent):void {
				var gl:GlowFilter = new GlowFilter(000000,0.7,30,30,4,1,true);
				ev.currentTarget.filters = [gl];
			}
			public function gDown(ev:MouseEvent):void {
				var gl:GlowFilter = new GlowFilter(000000,0.7,30,30,4,1,true);
				ev.currentTarget.filters = [gl];
			}
			public function gOut(ev:MouseEvent):void {
				ev.currentTarget.filters = [];
			}
			
			public function logprocess(s:String):void
			{
				if (s == 'c'){
					logcode = "";
				}
				else if (logcode.length < 4){
						logcode = logcode + s;
				}
				
				if (checkcode(logcode)){
					
					loginpad.visible = false;
					logcode = "";
					
				}
				else if (logcode.length == 4){
					logcode = "";
				}
				
			}
			public function checkcode(s:String):Boolean {
				sqlConnection = new SQLConnection();
				sqlConnection.open(File.applicationStorageDirectory.resolvePath("users.db"));
				var stmt:SQLStatement = new SQLStatement();
				stmt.sqlConnection = sqlConnection;
				stmt.text = "SELECT * FROM users where pass = " + s;
				stmt.execute();
				var resData:ArrayCollection = new ArrayCollection(stmt.getResult().data);
				
				if (resData.length != 0){
					logcode = "";
					loginpad.visible = false;
					return true;
				}
				else {
					//logcode = "";
					loginpad.visible = true;
					return false;
				}
				return false;
			}
		]]>
	</fx:Script>
	<s:BorderContainer width="100%" height="100%" >
<s:HGroup width="100%"  height="100%" >
	<s:VGroup  height="100%" width="30%" >
		<s:BorderContainer width="100%" borderWeight="3"  borderColor="#02446F" height="40%" >
			<s:Label id="userLBL" left="0" right="0" top="10" fontSize="25" fontWeight="normal"
					  text="Please Scan a User" textAlign="center"
					 verticalAlign="middle"/>
			<s:Label id="user" visible="false" bottom="0" width="100%" height="70" fontSize="12"
					 horizontalCenter="0"  text="User : {scannedText}"
					 textAlign="left"/>
		</s:BorderContainer>
		<s:BorderContainer width="100%"  borderWeight="3" 
						   borderColor="#02446F" height="60%" >
			<s:VGroup width="100%" height="100%" >
				<s:Button   id="scanBTN" enabled="false" label="Scan User" width="100%" height="100%" click="scanPress(event);" />
				<s:Button   id="processBTN"  enabled="false" label="Process Payment" width="100%" height="100%" click="processPress(event);" />
				<s:Button   id="resetBTN" label="Reset" width="100%" height="100%" click="resetPress(event);" />
			</s:VGroup>
		</s:BorderContainer>	
	</s:VGroup>
	<s:VGroup height="100%" width="70%"  >
		
		<s:BorderContainer width="100%"   height="97" borderWeight="3" borderColor="#02446F" >
			<s:Label   left="10" top="10" fontFamily="Verdana" fontSize="25" fontWeight="normal"
					 text="Total"/>
			<s:Label id="totalValue" left="84" right="31" top="0" bottom="4" fontSize="35"
					  text="0.00" textAlign="center" verticalAlign="middle"/>
			
		</s:BorderContainer>
		<s:BorderContainer width="100%"  borderWeight="3" borderColor="#02446F" height="80%" >
			<s:BorderContainer id="numkeycont" left="0" right="30" top="0" bottom="30"
							   borderColor="#02446F" borderVisible="false" borderWeight="3"
							   >
			<s:HGroup left="0"   right="0" top="0" bottom="0" verticalAlign="middle">
			<s:VGroup horizontalAlign="center" >
				<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
								   click="process('7');" horizontalCenter="-101">
					<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
							 text="7" verticalCenter="0"/>
				</s:BorderContainer>
			
				<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
								   click="process('4');" horizontalCenter="-101">
					<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
							 text="4" verticalCenter="0"/>
				</s:BorderContainer>
			
				<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
								   click="process('1');" horizontalCenter="-101">
					<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
							 text="1" verticalCenter="0"/>
				</s:BorderContainer>
				<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
								   click="process('0');" horizontalCenter="-101">
					<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
							 text="0" verticalCenter="0"/>
				</s:BorderContainer>
			</s:VGroup>
		
			
				<s:VGroup>
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('8');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="8" verticalCenter="0"/>
					</s:BorderContainer>
				
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('5');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="5" verticalCenter="0"/>
					</s:BorderContainer>
				
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('2');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="2" verticalCenter="0"/>
					</s:BorderContainer>
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('.');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="." verticalCenter="0"/>
					</s:BorderContainer>
				</s:VGroup>
			
				<s:VGroup>
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('9');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="9" verticalCenter="0"/>
					</s:BorderContainer>
			
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('6');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="6" verticalCenter="0"/>
					</s:BorderContainer>
				
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('3');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="3" verticalCenter="0"/>
					</s:BorderContainer>
					<s:BorderContainer top="45" width="{numkeycont.width/3}" height="{numkeycont.height/4}"  backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="process('c');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 text="c" verticalCenter="0"/>
					</s:BorderContainer>
				</s:VGroup>
			
			</s:HGroup>
			</s:BorderContainer>
		
			
		</s:BorderContainer>
	</s:VGroup>
</s:HGroup>
	
	</s:BorderContainer>
	<s:BorderContainer width="100%" height="100%" id="loginpad" visible="true"
					   backgroundAlpha="0.5" backgroundColor="#0A0A0A">
		<s:Label text="{logcode}" visible="true"
				 top="30" color="#FFFFFF" fontSize="40" fontWeight="bold"
				 horizontalCenter="0"/>
		<s:BorderContainer id="loginnumkeycont" top="80" bottom="0" width="500" backgroundAlpha="0"
						   borderVisible="false" borderWeight="0" horizontalCenter="0">
			<s:HGroup left="0" right="0" top="0" bottom="0" verticalAlign="middle">
				<s:VGroup horizontalAlign="center" >
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('7');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="7" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('4');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="4" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('1');" horizontalCenter="-101">
						<s:Label color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								 verticalCenter="0"
								 text="1"/>
					</s:BorderContainer>
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}"  
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('0');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="0" verticalCenter="0"/>
					</s:BorderContainer>
				</s:VGroup>
				
				
				<s:VGroup>
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('8');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="8" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('5');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="5" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('2');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="2" verticalCenter="0"/>
					</s:BorderContainer>
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="" verticalCenter="0"/>
					</s:BorderContainer>
				</s:VGroup>
				
				<s:VGroup>
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('9');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="9" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('6');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="6" verticalCenter="0"/>
					</s:BorderContainer>
					
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('3');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="3" verticalCenter="0"/>
					</s:BorderContainer>
					<s:BorderContainer top="45" width="{loginnumkeycont.width/3}" height="{loginnumkeycont.height/4}" 
									   backgroundColor="#02446F" mouseOut="gOut(event)" mouseOver="gOver(event)" mouseDown="gDown(event)"
									   click="logprocess('c');" horizontalCenter="-101">
						<s:Label   color="#FFFFFF" fontSize="40" fontWeight="bold" horizontalCenter="0"
								   text="c" verticalCenter="0"/>
					</s:BorderContainer>
				</s:VGroup>
				
			</s:HGroup>
		</s:BorderContainer>
	</s:BorderContainer>

</s:View>